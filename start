#/bin/bash

docker start kind-registry
docker start kind-control-plane

is_container_running() {
  local container_name=$1
  [ "$(docker inspect "$container_name" | jq -r '.[0].State.Status')" = "running" ]
}

# wait for registry
while ! is_container_running "kind-registry"; do
  echo "wait for kind registry..."
  sleep 5
done

# wait for control plane
while ! is_container_running "kind-control-plane"; do
  echo "wait for kind control plane..."
  sleep 5
done

(
# wait for typesense
while [ "$(kubectl describe pod -l "app=typesense" | grep Status | grep Running | wc -l)" -eq 0 ]; do
  echo "wait for typesense..."
  sleep 5
done
echo "typesense running"

# wait for api
while : ; do
  pod_id=$(kubectl get pods -l app=4ks-api -o=jsonpath='{.items[0].metadata.name}')
  if [ -n "$pod_id" ]; then
    if [ "$(kubectl describe pod $pod_id | grep Status | grep Running | wc -l)" -eq 1 ]; then
      if kubectl logs "$pod_id" 2>&1 | grep -q "\[GIN-debug\] Listening and serving HTTP on 0.0.0.0:5000"; then
        break
      fi
    fi
  fi
  echo "wait for api..."
  sleep 5
done
echo "api running"

# ./data/seed-tiny.sh
# ) &
# bg_pid=$!

tilt up --stream=true

sleep 240
kill $bg_pid